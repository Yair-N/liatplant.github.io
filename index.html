<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>צמחכם – סנכרון בסיסי</title>

<style>
body {
    font-family: system-ui, sans-serif;
    background: #101626;
    color: #eef2ff;
    margin: 0;
    padding: 20px;
}
button {
    padding: 10px 14px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    background: #4f72ff;
    color: white;
    font-weight: 600;
    margin-bottom: 12px;
}
button:hover {
    background: #6b86ff;
}
#logBox {
    white-space: pre-wrap;
    background: #0b1020;
    border: 1px solid #333;
    padding: 12px;
    border-radius: 8px;
    margin-top: 12px;
    height: 280px;
    overflow-y: auto;
    font-family: monospace;
    font-size: 14px;
}
.status {
    margin: 10px 0;
    font-size: 16px;
    font-weight: 500;
}
</style>
</head>

<body>

<h2>צמחכם – סנכרון בסיסי</h2>

<div class="status">
    מצב חיבור: <span id="status">מנותק</span>
</div>

<button id="connectBtn">התחבר / פתח פורט</button>
<button id="disconnectBtn">נתק</button>

<div id="logBox">-- אין נתונים עדיין --</div>

<script>
/****************************************************************
 * Minimal, stable WebSerial logic
 ****************************************************************/
let port = null;
let reader = null;
let keepReading = false;

const statusEl = document.getElementById("status");
const logBox  = document.getElementById("logBox");

function log(msg) {
    console.log(msg);
    logBox.textContent += "\n" + msg;
    logBox.scrollTop = logBox.scrollHeight;
}

function setStatus(txt) {
    statusEl.textContent = txt;
}

/****************************************************************
 * CONNECT LOGIC – bullet-proof, one call, user gesture only
 ****************************************************************/
document.getElementById("connectBtn").onclick = async () => {
    try {
        log("Opening device chooser...");
        const chosen = await navigator.serial.requestPort();   // MUST be in click handler
        log("Port selected.");
        port = chosen;

        await port.open({ baudRate: 115200 });
        log("Port opened!");
        setStatus("מחובר");

        startReading();
    }
    catch (err) {
        log("Connect error: " + err);
        setStatus("שגיאה / לא מחובר");
    }
};

/****************************************************************
 * DISCONNECT
 ****************************************************************/
document.getElementById("disconnectBtn").onclick = async () => {
    keepReading = false;

    try {
        if (reader) {
            await reader.cancel();
        }
        if (port) {
            await port.close();
        }
    } catch (e) {
        log("Disconnect error: " + e);
    }

    reader = null;
    port = null;
    setStatus("מנותק");
    log("Port closed.");
};

/****************************************************************
 * READ LOOP – Simple CSV gateway format
 * Expected CSV: plantId,uptime_ms,soil,light,temp
 ****************************************************************/
async function startReading() {
    keepReading = true;
    const decoder = new TextDecoderStream();
    const closed = port.readable.pipeTo(decoder.writable);
    reader = decoder.readable.getReader();

    let buffer = "";

    while (keepReading) {
        try {
            const { value, done } = await reader.read();
            if (done) break;

            if (value) {
                buffer += value;
                let lines = buffer.split(/\r?\n/);
                buffer = lines.pop();

                for (const line of lines) {
                    handleLine(line.trim());
                }
            }
        }
        catch (err) {
            log("Read error: " + err);
            break;
        }
    }
}

/****************************************************************
 * Handle incoming gateway CSV lines
 ****************************************************************/
function handleLine(line) {
    if (!line) return;

    log("RX: " + line);

    if (line.startsWith("#")) return;

    const parts = line.split(",");
    if (parts.length === 5) {
        const [plantId, uptime, soil, light, temp] = parts;
        log(`Parsed CSV → ID=${plantId}, U=${uptime}ms, S=${soil}%, L=${light}%, T=${temp}°`);
    }
}
</script>

</body>
</html>
